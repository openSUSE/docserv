#!/bin/bash
# $1 - Schema file (RelaxNG compact/RNC)
# $2 - Directory with config files
# $3 - Output file (optional, if not set, outputs to stdout)

out() {
  >&2 echo "$1"
  exit 1
}

starlet='xmlstarlet'

stacksize=${stacksize:-"-Xss4096K"}
java_flags="-Dorg.apache.xerces.xni.parser.XMLParserConfiguration=org.apache.xerces.parsers.XIncludeParserConfiguration"


[[ ! -f $1 ]] && out "Schema $1 does not exist."
schema=$1

[[ ! -d $2 ]] && out "Directory $2 does not exist."
indir=$2

cd $indir

for file in *.xml; do
  [[ $(2>&1 xmllint --noout --noent $file) ]] && out "$indir/$file is not well-formed."
  ADDITIONAL_FLAGS="$java_flags" ADDITIONAL_OPTIONS="$java_flags" \
    jing -ci $schema $file
done

outfile='<?xml version="1.0" encoding="UTF-8"?>\n<docservconfig>\n\n'

for file in *.xml; do
  outfile+=$($starlet sel -t -c "/*" $file)
  outfile+='\n'
done

outfile+='\n</docservconfig>\n'

cd -

if [[ $2 ]]; then
  echo -e "$outfile" > $2
else
  echo -e "$outfile"
fi
