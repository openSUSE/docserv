#! /bin/bash
# Generate navigational pages for DocServ.
#
# Mandatory parameters:
#   --stitched-config="/path/to/file.xml"    # Full docservconfig file
#                                              (non-positive version)
#   --template-dir="/path/to/templates"
#   --cache-dir="/var/cache/docserv/target"  # Document metadata cache directory
#                                              as generated by docserv script
#   --output-dir="/path/to/output"           # Where to output HTML files
#   --ui-languages="en-us de-de"             # Languages that are supported
#                                              by the UI templates
#   --internal-mode                          # Enable features that are not
#                                              supposed to be shown publically
#   --product                                # Product to build UI for
#   --docset                                 # Docset to build UI for
#
# Optional parameters:
#   --help                                   # Show this help screen

out() {
  >&2 echo -e "$1"
  exit 1
}


me=$(test -L $(realpath $0) && readlink $(realpath $0) || echo $(realpath $0))
mydir=$(dirname $me)

source $mydir/docserv-dirs

app_help() {
  sed -rn '/#!/{n; p; :loop n; p; /^[ \t]*$/q; b loop}' $me | sed -r -e 's/^# ?//' -e "s/\\\$0/$(basename $0)/"
  exit
}

xsltproc='xsltproc'
xmllint='xmllint'
jing='jing'
starlet='xmlstarlet'

stylesheet=$share_dir/build-navigation/build-navigation-json.xsl
[[ ! -f $stylesheet ]] && out "Stylesheet $stylesheet does not exist.$(readme_message)"

stitched_config=

ui_languages=
product=
docset=

template_dir=
cache_dir=
output_dir=
internal_mode='false'

for i in "$@"
  do
    case $i in
      -h|--help)
        app_help
      ;;
      --internal-mode)
        internal_mode='true'
      ;;
      --product=*)
        product="${i#*=}"
      ;;
      --docset=*)
        docset="${i#*=}"
      ;;
      --ui-languages=*)
        ui_languages="${i#*=}"
      ;;
      --stitched-config=*)
        stitched_config="${i#*=}"
      ;;
      --template-dir=*)
        template_dir="${i#*=}"
      ;;
      --cache-dir=*)
        cache_dir="${i#*=}"
      ;;
      --output-dir=*)
        output_dir="${i#*=}"
      ;;
      *)
        unknown+="  $i\n"
      ;;
    esac
done

[[ "$unknown" ]] && \
  out "There are unknown parameters:\n$unknown"

for lang in "$ui_languages"; do
  [[ $(echo -e " $lang" | sed -r 's/( [a-z]{2}(-[a-z]{2,5})?)+//') ]] && out "Language parameter ($lang) is not in the right format."
done

for file in "$stitched_config"; do
  [[ ! -f "$file" ]] && out "File $file does not exist."
done

for dir in "$cache_dir" "$template_dir" "$output_dir"; do
  [[ ! -d "$dir" ]] && out "Directory $dir does not exist."
done

allproducts=$($xsltproc $share_dir/build-navigation/list-all-products.xsl "$stitched_config")
if [[ ! $(echo -e "$allproducts" | grep -oP "^${product}/${docset}\$") ]]; then
  out "Either product $product or docset $docset does not exist."
fi


template_dir=$(readlink -f $template_dir)
cache_dir=$(readlink -f $cache_dir)
output_dir=$(readlink -f $output_dir)

template_html=$template_dir/template.html
template_translation=$template_dir/translation.xml
template_resources=$template_dir/res

for file in $template_html $template_translation $template_resources; do
  ([[ ! -d "$file" ]] && [[ ! -f "$file" ]]) && out "File/directory $file does not exist."
done

# CREATE DIRECTORY TREE FOR OUTPUT
temp_dir=$(mktemp -d /tmp/docserv-build-navigation-XXXXXXXX)

# Where to place the JSON data files
data_path='docserv/data'
# Where to place the template's resource files (JS, CSS, images)
res_path='docserv/res'
for product in $allproducts; do
  mkdir -p $output_dir/$data_path/$product
done
for lang in "$ui_languages"; do
  for product in $allproducts; do
    mkdir -p $output_dir/$lang/$product
  done
done

cache_file=$temp_dir/cache.xml
cache_files=$(find "$cache_dir" -name '*.xml')
stitched_cache='<?xml version="1.0" encoding="UTF-8"?>\n<docservcache>\n\n'
for file in $cache_files; do
  stitched_cache+=$($starlet sel -t -c "/document" $file)
  stitched_cache+='\n'
done
stitched_cache+='\n</docservcache>\n'
echo -e "$stitched_cache" > $cache_file


xsltproc \
  --stringparam "output_root" "$output_dir/$data_path/" \
  --stringparam "cache_file" "$cache_file" \
  --stringparam "internal_mode" "$internal_mode" \
  --stringparam "ui_languages" "$ui_languages" \
  --stringparam "product" "$product" \
  --stringparam "docset" "$docset" \
  "$stylesheet" \
  "$stitched_config"

# Clean up stray ',' characters that are extremely hard to avoid when
# generating JSON via XSLT.
json_files=$(find "$output_dir" -name '*.json')
for json_file in $json_files; do
  sed -r -e 's/\s*$//' "$json_file" | \
    tr '\n' '\r' | \
    sed -r \
      -e 's/,(\s*|\r*)([]}])/\2/g' \
      -e 's/\r\r*/\r/g' \
      -e 's/\r/\n/g' | \
    sed -n '/^\s*$/ !p' \
      > "$json_file.0"
  mv "$json_file.0" "$json_file"
done

#cp -r $template_resources $output_dir
echo "-> $output_dir"
